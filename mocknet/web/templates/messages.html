{{define "content"}}
<section class="card" data-testid="messages-card">
  <div class="row between">
    <h1 data-testid="messages-title">Messaging</h1>
    <span class="badge" data-testid="messages-thread-count">{{.ThreadCount}} conversations</span>
  </div>

  <div class="row" data-testid="messages-toolbar">
    <input class="grow" placeholder="Search messages" aria-label="Search messages" data-testid="messages-search" />
    <span class="badge" data-testid="messages-filter">Inbox</span>
    <a class="btn secondary" href="/search" data-testid="messages-new">New message</a>
  </div>

  <div class="messages" data-testid="messages-layout">
    <aside class="threads" data-testid="threads">
      <h2 data-testid="threads-title">Messages</h2>

      {{range .Threads}}
        <a class="thread {{if eq $.SelectedThreadID .ThreadID}}active{{end}}" href="/messages?thread={{.ThreadID}}" data-testid="thread-link" data-thread-id="{{.ThreadID}}" data-profile-id="{{.ProfileID}}">
          <div class="name">{{.Name}}</div>
          <div class="meta">{{.Company}}</div>
        </a>
      {{else}}
        <div class="empty" data-testid="threads-empty">No conversations yet<br><small>Accept a connection to start messaging</small></div>
      {{end}}
    </aside>

    <section class="threadview" data-testid="thread-view">
      {{if .SelectedThreadID}}
        {{$p := index .Profiles .SelectedProfileID}}
        <div class="row between">
          <div>
            <h2 data-testid="thread-title">{{$p.First}} {{$p.Last}}</h2>
            <div class="meta">{{$p.Title}} â€¢ {{$p.Company}}</div>
          </div>
        </div>

        <div class="chat" data-testid="message-list">
          {{range .Messages}}
            <div class="msg {{if .FromSelf}}me{{else}}them{{end}}" data-testid="message-item">
              <div class="bubble" data-testid="message-body">{{.Body}}</div>
            </div>
          {{else}}
            <div class="empty" data-testid="message-empty">No messages yet.</div>
          {{end}}
        </div>

        <form method="post" action="/messages/send" class="row" data-testid="message-form" id="message-form">
          <input type="hidden" name="profile_id" value="{{.SelectedProfileID}}" data-testid="message-profile-id" />
          <input name="body" class="grow" placeholder="Type a message..." data-testid="message-input" id="message-input" />
          <button type="button" class="btn" data-testid="message-send" id="send-btn">Send</button>
        </form>
        <script>
          document.getElementById('send-btn').addEventListener('click', async function(e) {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const profileId = document.querySelector('input[name="profile_id"]').value;
            const body = input.value.trim();
            
            if (!body) return;
            
            console.log('Sending message:', { profileId, body });
            
            try {
              const response = await fetch('/messages/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'profile_id=' + encodeURIComponent(profileId) + '&body=' + encodeURIComponent(body)
              });
              
              console.log('Response status:', response.status);
              
              if (response.ok) {
                console.log('Message sent successfully');
                input.value = '';
                window.location.reload();
              } else {
                const text = await response.text();
                console.error('Error:', text);
                alert('Error sending message: ' + text);
              }
            } catch (error) {
              console.error('Fetch error:', error);
              alert('Network error: ' + error.message);
            }
          });
        </script>
      {{else}}
        <div class="empty" data-testid="message-select">Select a thread.</div>
      {{end}}
    </section>
  </div>
</section>
{{end}}
{{template "layout" .}}
